FROM node:16-alpine
################################################################################
# Original Source
# https://github.com/AndreySenov/firebase-tools-docker/blob/main/Dockerfile
# https://github.com/goat-io/fluent/blob/master/src/Docker/Database/Firebase/Dockerfile
################################################################################

ARG BUILD_DATE
ARG VERSION
ARG VCS_REF
LABEL org.label-schema.schema-version="1.0" \
    org.label-schema.name="" \
    org.label-schema.version=${VERSION} \
    org.label-schema.build-date=${BUILD_DATE} \
    org.label-schema.description="" \
    org.label-schema.url="" \
    org.label-schema.vcs-url="" \
    org.label-schema.vcs-ref=${VCS_REF}
ENV FIREBASE_TOOLS_VERSION=${VERSION}
ENV HOME=/home/node

# Install Java, Curl and Firebase-Tools
RUN apk --no-cache add curl openjdk11-jre bash && \
    yarn global add firebase-tools@${VERSION} && \
    yarn cache clean   

# Check versions
RUN firebase -V && \
    java -version && \
    chown -R node:node $HOME   

# First run to setup emulators
RUN firebase setup:emulators:database && \
    firebase setup:emulators:firestore && \
    firebase setup:emulators:pubsub && \
    firebase setup:emulators:storage && \
    firebase setup:emulators:ui

# Install gcloud commmand utilities to use default login (requires python)
# RUN curl -sSL https://sdk.cloud.google.com > /tmp/gcl && bash /tmp/gcl --install-dir=~/gcloud --disable-prompts
# ENV PATH $PATH:~/gcloud/google-cloud-sdk/bin

WORKDIR /app

# Only install packages if package.json has changed
RUN mkdir -p /app/functions/dist
COPY ./app/functions/dist/package.json /app/functions/dist/package.json
RUN cd /app/functions/dist && yarn install

# Copy additional config files (done individually to not override dist package.json)
COPY ./app/firebase.json /app/firebase.json
COPY ./app/.firebaserc /app/.firebaserc
COPY ./app/firebase.storage.rules /app/firebase.storage.rules
COPY ./app/functions/dist/index.js /app/functions/dist/index.js
COPY ./app/credentials.json /app/credentials.json

# Copy seed data
RUN mkdir -p /app/import
COPY ./import /app/import

# Prompt firebase to use json credentials for login by exporting variable
ENV GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json

# Ensure emulators configured to run and perform any 1-time ops
RUN firebase emulators:exec --project  ${FIRESTORE_PROJECT_NAME:-demo-community-platform} --import=/app/import ls

# # Exposed Ports - These should match firebase.json config
EXPOSE 4001 4002 4003 4004 4005 4006 4007

# # Troubleshooting - can just run to get cli access
# CMD [ "/bin/sh" ]

CMD firebase emulators:start --only auth,functions,firestore,pubsub,storage,hosting,database --project ${FIRESTORE_PROJECT_NAME:-demo-community-platform} --import=/app/import




